import { createRoot } from "react-dom/client";
import App from "./App";
import "./index.css";

// Initialize IndexedDB lazily to improve initial load time
if (typeof window !== 'undefined') {
  import("./lib/indexeddb").then(({ indexedDBService }) => {
    indexedDBService.init().catch(console.error);
  });

  // Development-specific initialization
  if (process.env.NODE_ENV === 'development') {
    import("./utils/pwa-debug");
    import("./utils/cache-killer").then(({ clearAllCaches, unregisterAllServiceWorkers }) => {
      // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÑÑˆÐ¸ Ð¸ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ SW Ð² Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ
      Promise.all([
        clearAllCaches(),
        unregisterAllServiceWorkers()
      ]).then(() => {
        console.log('ðŸ§¹ Ð¡Ñ€ÐµÐ´Ð° Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ð° Ð¾Ñ‚ ÐºÑÑˆÐµÐ¹');
      });
    });
  }
}

// Service Worker registration - only in production
if ('serviceWorker' in navigator && process.env.NODE_ENV === 'production') {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('âœ… Service Worker Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½:', registration);
        
        // ÐÐ³Ñ€ÐµÑÑÐ¸Ð²Ð½Ð°Ñ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð´Ð»Ñ production
        registration.update();
        
        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð½Ð¾Ð²Ñ‹Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹ Service Worker
        registration.addEventListener('updatefound', () => {
          console.log('ðŸ†• ÐÐ°Ð¹Ð´ÐµÐ½Ð° Ð½Ð¾Ð²Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ Service Worker');
          const newWorker = registration.installing;
          if (newWorker) {
            newWorker.addEventListener('statechange', () => {
              console.log('ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð½Ð¾Ð²Ð¾Ð³Ð¾ SW:', newWorker.state);
              if (newWorker.state === 'installed') {
                if (navigator.serviceWorker.controller) {
                  // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ
                  console.log('âš¡ ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Service Worker');
                  newWorker.postMessage({ type: 'SKIP_WAITING' });
                } else {
                  // ÐŸÐµÑ€Ð²Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°
                  console.log('ðŸŽ‰ Service Worker ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð²Ð¿ÐµÑ€Ð²Ñ‹Ðµ');
                }
              }
            });
          }
        });
        
        // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ ÑÐ¼ÐµÐ½Ðµ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€Ð°
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          console.log('ðŸ”„ ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»ÑÑ, Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ');
          // ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÑÑˆÐ¸ Ð¿ÐµÑ€ÐµÐ´ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¾Ð¹
          if ('caches' in window) {
            caches.keys().then((cacheNames) => {
              return Promise.all(
                cacheNames.map((cacheName) => caches.delete(cacheName))
              );
            }).then(() => {
              window.location.reload();
            }).catch(() => {
              // Ð’ ÑÐ»ÑƒÑ‡Ð°Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ ÐºÑÑˆÐ° Ð²ÑÐµ Ñ€Ð°Ð²Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ÑÑ
              window.location.reload();
            });
          } else {
            window.location.reload();
          }
        });
        
        // ÐŸÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹
        setInterval(() => {
          registration.update();
        }, 60000); // ÐšÐ°Ð¶Ð´ÑƒÑŽ Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
        
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸ Ñ„Ð¾ÐºÑƒÑÐµ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ
        window.addEventListener('focus', () => {
          registration.update();
        });
        
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
        window.addEventListener('beforeunload', () => {
          registration.update();
        });
      })
      .catch((registrationError) => {
        console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Service Worker:', registrationError);
      });
  });
} else if (process.env.NODE_ENV === 'development') {
  console.log('ðŸš§ Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°: Service Worker Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½ Ð´Ð»Ñ Ð¸Ð·Ð±ÐµÐ¶Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ñ ÐºÑÑˆÐµÐ¼');
  
  // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²ÑÐµ ÐºÑÑˆÐ¸ Ð² Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ
  if ('caches' in window) {
    caches.keys().then(cacheNames => {
      Promise.all(
        cacheNames.map(cacheName => caches.delete(cacheName))
      );
    });
  }
  
  // ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ service worker'Ñ‹
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      for (let registration of registrations) {
        registration.unregister();
      }
    });
  }
}

createRoot(document.getElementById("root")!).render(<App />);
