import{r as h,j as t,L as N,h as D,e as q,i as $,P as j,M as S,q as o}from"./index-Bl7s4VzA.js";import{u as w}from"./useMutation-CyJnlrj4.js";import{C as T}from"./check-BlHW5vLV.js";function A({category:a}){const[f,m]=h.useState(!1);return t.jsx(N,{href:`/catalog/${a.id}`,children:t.jsxs("button",{className:"bg-white dark:bg-card rounded-xl p-4 shadow-sm text-center card-hover w-full",children:[f||!a.imageUrl?t.jsx("div",{className:"w-12 h-9 mx-auto mb-2 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center",children:t.jsx("span",{className:"text-gray-400 dark:text-gray-500 text-xs",children:"üìã"})}):t.jsx("img",{src:a.imageUrl,alt:a.name,className:"w-12 h-9 mx-auto mb-2 rounded-lg object-cover",onError:()=>m(!0)}),t.jsx("span",{className:"text-xs font-medium text-gray-700 dark:text-gray-200 line-clamp-1",children:a.name})]})})}function I({product:a}){const{toast:f}=D(),{cartItems:m}=q(),[b,x]=h.useState(!1),[C,k]=h.useState(!1),[u,l]=h.useState(!1),d=$(),n=m.find(e=>e.productId===a.id),p=(n==null?void 0:n.quantity)||0,g=w({mutationFn:async()=>{const e=await fetch("/api/cart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:d,productId:a.id,quantity:1})});if(!e.ok)throw new Error("Failed to add to cart");return e.json()},onMutate:async()=>{x(!0),await o.cancelQueries({queryKey:["/api/cart",d]});const e=o.getQueryData(["/api/cart",d]);return o.setQueryData(["/api/cart",d],r=>r?r.find(i=>{var c;return((c=i==null?void 0:i.product)==null?void 0:c.id)===a.id})?r.map(i=>{var c;return((c=i==null?void 0:i.product)==null?void 0:c.id)===a.id?{...i,quantity:i.quantity+1}:i}):[...r,{id:`temp-${Date.now()}-${a.id}`,userId:d,productId:a.id,quantity:1,product:a}]:[]),{previousCart:e}},onSuccess:e=>{o.setQueryData(["/api/cart",d],r=>r?r.find(i=>{var c;return(c=i==null?void 0:i.id)==null?void 0:c.startsWith("temp-")})?r.map(i=>{var c;return(c=i==null?void 0:i.id)!=null&&c.startsWith("temp-")&&i.productId===a.id?{...i,id:e.id}:i}):r:[]),setTimeout(()=>x(!1),2e3)},onError:(e,r,s)=>{console.error("Add to cart error:",e),s!=null&&s.previousCart&&o.setQueryData(["/api/cart",d],s.previousCart),x(!1),f({title:"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏",description:"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞",variant:"destructive"})}}),y=w({mutationFn:async({quantity:e})=>{if(!(n!=null&&n.id))throw new Error("Cart item not found");const r=await fetch(`/api/cart/${n.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({quantity:e})});if(!r.ok)throw new Error("Failed to update cart item");return r.json()},onMutate:async({quantity:e})=>{await o.cancelQueries({queryKey:["/api/cart",d]});const r=o.getQueryData(["/api/cart",d]);return o.setQueryData(["/api/cart",d],s=>!s||!(n!=null&&n.id)?s||[]:s.map(i=>i.id===n.id?{...i,quantity:e}:i)),{previousCart:r}},onSuccess:e=>{o.setQueryData(["/api/cart",d],r=>!r||!(n!=null&&n.id)?r||[]:r.map(s=>s.id===n.id?e:s))},onError:(e,r,s)=>{console.error("Update quantity error:",e),s!=null&&s.previousCart&&o.setQueryData(["/api/cart",d],s.previousCart),f({title:"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏",description:"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞",variant:"destructive"})}}),v=w({mutationFn:async()=>{if(!(n!=null&&n.id))throw new Error("Cart item not found");if(!(await fetch(`/api/cart/${n.id}`,{method:"DELETE"})).ok)throw new Error("Failed to remove cart item")},onMutate:async()=>{await o.cancelQueries({queryKey:["/api/cart",d]});const e=o.getQueryData(["/api/cart",d]);return o.setQueryData(["/api/cart",d],r=>!r||!(n!=null&&n.id)?r||[]:r.filter(s=>s.id!==n.id)),{previousCart:e}},onError:(e,r,s)=>{console.error("Remove item error:",e),s!=null&&s.previousCart&&o.setQueryData(["/api/cart",d],s.previousCart),f({title:"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏",description:"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞",variant:"destructive"})}}),P=e=>{e.preventDefault(),e.stopPropagation(),!(u||g.isPending)&&(l(!0),g.mutate(void 0,{onSettled:()=>{l(!1)}}))},E=e=>{e.preventDefault(),e.stopPropagation(),!u&&(l(!0),p===0?g.mutate(void 0,{onSettled:()=>l(!1)}):y.mutate({quantity:p+1},{onSettled:()=>l(!1)}))},Q=e=>{e.preventDefault(),e.stopPropagation(),!u&&(l(!0),p===1?v.mutate(void 0,{onSettled:()=>l(!1)}):y.mutate({quantity:p-1},{onSettled:()=>l(!1)}))};return t.jsx(N,{href:`/product/${a.id}`,children:t.jsxs("div",{className:"bg-white dark:bg-card rounded-xl shadow-sm overflow-hidden card-hover cursor-pointer","data-testid":`card-product-${a.id}`,children:[C||!a.imageUrl?t.jsx("div",{className:"w-full h-32 bg-gray-100 dark:bg-gray-800 flex items-center justify-center",children:t.jsxs("div",{className:"text-gray-400 dark:text-gray-600 text-center",children:[t.jsx("div",{className:"text-2xl mb-1",children:"üì¶"}),t.jsx("div",{className:"text-xs",children:"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"})]})}):t.jsx("img",{src:a.imageUrl,alt:a.name,className:"w-full h-32 object-cover","data-testid":"img-product",onError:()=>k(!0)}),t.jsxs("div",{className:"p-3",children:[t.jsx("h4",{className:"font-medium text-gray-900 dark:text-gray-100 text-sm mb-1 line-clamp-2","data-testid":"text-product-name",children:a.name}),t.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mb-2","data-testid":"text-product-weight",children:a.weight}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("span",{className:"font-bold text-gray-900 dark:text-gray-100","data-testid":"text-product-price",children:[parseFloat(a.price).toFixed(0)," —Å."]}),p===0?t.jsx("button",{onClick:P,disabled:g.isPending||u,className:`w-8 h-8 rounded-lg flex items-center justify-center transition-colors ${b?"bg-electric-green":"bg-agent-purple hover:bg-agent-purple/90"} ${g.isPending||u?"opacity-70 cursor-not-allowed":""}`,"data-testid":"button-add-to-cart",children:b?t.jsx(T,{className:"w-4 h-4 text-white"}):t.jsx(j,{className:"w-4 h-4 text-white"})}):t.jsxs("div",{className:"flex items-center space-x-1","data-testid":`quantity-controls-${a.id}`,children:[t.jsx("button",{onClick:Q,disabled:y.isPending||v.isPending||u,className:`w-7 h-7 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center justify-center transition-colors ${y.isPending||v.isPending||u?"opacity-50 cursor-not-allowed":""}`,"data-testid":`button-decrease-${a.id}`,children:t.jsx(S,{className:"w-3 h-3 text-gray-600 dark:text-gray-300"})}),t.jsx("span",{className:"w-8 text-center font-bold text-sm text-gray-900 dark:text-gray-100","data-testid":`text-quantity-${a.id}`,children:p}),t.jsx("button",{onClick:E,disabled:g.isPending||y.isPending||u,className:`w-7 h-7 rounded-lg bg-agent-purple hover:bg-agent-purple/90 flex items-center justify-center transition-colors ${g.isPending||y.isPending||u?"opacity-50 cursor-not-allowed":""}`,"data-testid":`button-increase-${a.id}`,children:t.jsx(j,{className:"w-3 h-3 text-white"})})]})]})]})]})})}export{A as C,I as P};
