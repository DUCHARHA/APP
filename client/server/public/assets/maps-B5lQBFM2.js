import{r as p,h as K,s as T,a as P,j as e,t as k,L as N,B as g,X as $,S as M,I as Y,ae as F}from"./index-Bl7s4VzA.js";import{D as _,b as q,c as H,d as J,e as U}from"./dialog-DCOcG2c2.js";import{A as G}from"./arrow-left-Dp1lr5Kg.js";import{C as Q}from"./check-BlHW5vLV.js";import"./index-B7K4-hLV.js";const C=[38.5598,68.787],S=[38.5598,68.787];function te(){const f=p.useRef(null),r=p.useRef(null),[y,R]=p.useState(""),[v,l]=p.useState(!1),[x,j]=p.useState(null),[A,b]=p.useState(!1),{toast:a}=K(),[,D]=T(),{data:o}=P({queryKey:["/api/config/yandex-maps"],staleTime:1/0});p.useEffect(()=>{if(!(o!=null&&o.apiKey)||!f.current)return;const s=()=>new Promise((t,c)=>{var m,u;const d=document.getElementById("ymaps-script");if(d&&window.ymaps){const h=(u=(m=window.ymaps)==null?void 0:m.meta)==null?void 0:u.coordinatesOrder,z=d.src||"";if(h!=="latlong"||!z.includes("coordorder=latlong"))d.remove(),delete window.ymaps;else{t();return}}if(document.getElementById("ymaps-script")){const h=document.getElementById("ymaps-script");h.addEventListener("load",()=>t()),h.addEventListener("error",()=>c(new Error("Failed to load Yandex Maps")));return}const n=document.createElement("script");n.id="ymaps-script",n.src=`https://api-maps.yandex.ru/2.1/?apikey=${o.apiKey}&lang=ru_RU&load=package.full&coordorder=latlong`,n.defer=!0,n.addEventListener("load",()=>t()),n.addEventListener("error",()=>c(new Error("Failed to load Yandex Maps"))),document.head.appendChild(n)});return(async()=>{try{if(await s(),!window.ymaps)throw new Error("Yandex Maps not available");window.ymaps.ready(()=>{try{const t=new window.ymaps.Map(f.current,{center:C,zoom:12,controls:["zoomControl","fullscreenControl"]});setTimeout(()=>{t.setCenter(C,12,{duration:0})},100);const c=new window.ymaps.Placemark(S,{balloonContent:"–î–£–ß–ê–†–•–ê - –ú–∞–≥–∞–∑–∏–Ω",hintContent:"–ù–∞—à –º–∞–≥–∞–∑–∏–Ω"},{preset:"islands#redDotIcon"});t.geoObjects.add(c),t.events.add("click",d=>{const n=d.get("coords");console.log("Clicked coordinates:",n),E(n)}),r.current={map:t,storeMarker:c,customerMarker:null,route:null}}catch(t){console.error("Map initialization error:",t),a({title:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã",description:"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.",variant:"destructive"})}})}catch(t){console.error("Yandex Maps loading error:",t),a({title:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç",description:"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.",variant:"destructive"})}})(),()=>{var t;(t=r.current)!=null&&t.map&&(r.current.map.destroy(),r.current=null)}},[o==null?void 0:o.apiKey]);const E=async s=>{if(console.log("handleMapClick called with coordinates:",s),!window.ymaps||!r.current){console.error("ymaps or mapDataRef not available");return}l(!0);try{window.ymaps.geocode(s,{results:1}).then(t=>{var u;const c=t.geoObjects.get(0);if(!c){a({title:"–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω",description:"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–¥—Ä–µ—Å –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–µ",variant:"destructive"}),l(!1);return}const d=c.getAddressLine(),n=c.properties.get("text");(u=r.current)!=null&&u.customerMarker&&r.current.map.geoObjects.remove(r.current.customerMarker);const m=new window.ymaps.Placemark(s,{balloonContent:`–í—ã–±—Ä–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å: ${d}`,hintContent:"–í—ã–±—Ä–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏"},{preset:"islands#greenDotIcon"});r.current.map.geoObjects.add(m),r.current.customerMarker=m,j({coordinates:s,address:d,description:n}),b(!0),l(!1),a({title:"–ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω",description:`–í—ã–±—Ä–∞–Ω: ${d}`})}).catch(t=>{console.error("Reverse geocoding error:",t),a({title:"–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞",description:"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–¥—Ä–µ—Å –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–µ",variant:"destructive"}),l(!1)})}catch(i){console.error("Map click error:",i),a({title:"–û—à–∏–±–∫–∞",description:"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∞–¥—Ä–µ—Å–∞",variant:"destructive"}),l(!1)}},O=()=>{if(!x)return;const s={id:Date.now().toString(),title:"–í—ã–±—Ä–∞–Ω–Ω—ã–π –Ω–∞ –∫–∞—Ä—Ç–µ",address:x.address,coordinates:x.coordinates,type:"other",isDefault:!1,timestamp:new Date().toISOString()},i=localStorage.getItem("user-addresses"),t=i?JSON.parse(i):[];t.push(s),localStorage.setItem("user-addresses",JSON.stringify(t)),a({title:"–ê–¥—Ä–µ—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω",description:"–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω"}),D("/addresses")},I=()=>{var s;b(!1),j(null),(s=r.current)!=null&&s.customerMarker&&(r.current.map.geoObjects.remove(r.current.customerMarker),r.current.customerMarker=null)},w=async()=>{if(!y.trim()||!r.current||!(o!=null&&o.apiKey)){a({title:"–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å",description:"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞",variant:"destructive"});return}l(!0);try{window.ymaps.geocode(`–î—É—à–∞–Ω–±–µ, ${y}`,{results:1}).then(i=>{var u;const t=i.geoObjects.get(0);if(!t){a({title:"–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω",description:"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ —É–∫–∞–∑–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å",variant:"destructive"}),l(!1);return}const c=t.geometry.getCoordinates(),d=t.getAddressLine();(u=r.current)!=null&&u.customerMarker&&r.current.map.geoObjects.remove(r.current.customerMarker);const n=new window.ymaps.Placemark(c,{balloonContent:`–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏: ${d}`,hintContent:"–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏"},{preset:"islands#blueDotIcon"});r.current.map.geoObjects.add(n),r.current.customerMarker=n;const m=r.current.map.geoObjects.getBounds();r.current.map.setBounds(m,{checkZoomRange:!0,zoomMargin:50}),a({title:"–ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω",description:`–ù–∞–π–¥–µ–Ω –∞–¥—Ä–µ—Å: ${d}`}),l(!1)}).catch(i=>{console.error("Geocoding error:",i),a({title:"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞",description:"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å",variant:"destructive"}),l(!1)})}catch(s){console.error("Search error:",s),a({title:"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞",description:"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∞–¥—Ä–µ—Å–∞",variant:"destructive"}),l(!1)}},L=()=>{var s;if(!((s=r.current)!=null&&s.customerMarker)||!(o!=null&&o.apiKey)){a({title:"–°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –∞–¥—Ä–µ—Å",description:"–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞",variant:"destructive"});return}try{const i=r.current.customerMarker.geometry.getCoordinates();r.current.route&&r.current.map.geoObjects.remove(r.current.route);const t=new window.ymaps.multiRouter.MultiRoute({referencePoints:[S,i],params:{routingMode:"auto"}},{boundsAutoApply:!0,routeActiveStrokeWidth:6,routeActiveStrokeColor:"#5B21B6"});r.current.map.geoObjects.add(t),r.current.route=t,t.model.events.add("requestsuccess",()=>{const c=t.getActiveRoute();if(c){const d=c.properties.get("distance"),n=c.properties.get("duration"),m=d.text,u=n.text;a({title:"–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω",description:`–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${m}, –≤—Ä–µ–º—è –≤ –ø—É—Ç–∏: ${u}`})}})}catch(i){console.error("Route building error:",i),a({title:"–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞",description:"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç",variant:"destructive"})}},B=s=>{s.key==="Enter"&&w()};return o!=null&&o.apiKey?e.jsxs("div",{className:"flex flex-col h-screen bg-background",children:[e.jsxs("div",{className:"p-4 border-b bg-white dark:bg-gray-900",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx(N,{href:"/",children:e.jsxs(g,{variant:"ghost",size:"sm","data-testid":"button-back",children:[e.jsx(G,{className:"h-4 w-4 mr-2"}),"–ù–∞–∑–∞–¥"]})}),e.jsx("h1",{className:"text-xl font-bold text-foreground flex-1 text-center",children:"üó∫Ô∏è –ö–∞—Ä—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏"}),e.jsx(N,{href:"/",children:e.jsx(g,{variant:"ghost",size:"sm","data-testid":"button-close",className:"border border-gray-300 hover:bg-gray-100 dark:border-gray-600 dark:hover:bg-gray-800",children:e.jsx($,{className:"h-4 w-4"})})})]}),e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(M,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Y,{"data-testid":"input-address-search",type:"text",placeholder:"–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏...",value:y,onChange:s=>R(s.target.value),onKeyPress:B,className:"pl-10",disabled:v})]}),e.jsx(g,{"data-testid":"button-search-address",onClick:w,disabled:v,size:"sm",children:e.jsx(M,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(g,{"data-testid":"button-select-address",onClick:()=>a({title:"–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ",description:"–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏"}),variant:"default",size:"sm",className:"flex-1",children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ"]}),e.jsxs(g,{"data-testid":"button-build-route",onClick:L,variant:"outline",size:"sm",className:"flex-1",children:[e.jsx(F,{className:"h-4 w-4 mr-2"}),"–ú–∞—Ä—à—Ä—É—Ç"]})]})]})]}),e.jsx("div",{className:"flex-1",children:e.jsx("div",{ref:f,className:"w-full h-full","data-testid":"map-container"})}),e.jsx(_,{open:A,onOpenChange:b,children:e.jsxs(q,{className:"sm:max-w-md",children:[e.jsxs(H,{children:[e.jsx(J,{children:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–¥—Ä–µ—Å"}),e.jsx(U,{children:"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏"})]}),x&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 rounded-lg p-3",children:[e.jsx("h4",{className:"font-medium text-sm text-gray-900 dark:text-gray-100 mb-1",children:"üìç –í—ã–±—Ä–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å:"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:x.address})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{variant:"outline",onClick:I,className:"flex-1","data-testid":"button-dialog-cancel",children:"–û—Ç–º–µ–Ω–∏—Ç—å"}),e.jsxs(g,{onClick:O,disabled:v,className:"flex-1","data-testid":"button-dialog-confirm",children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–¥—Ä–µ—Å"]})]})]})]})})]}):e.jsx("div",{className:"p-4 min-h-screen bg-background",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(k,{className:"mx-auto h-12 w-12 text-muted-foreground mb-4"}),e.jsx("h2",{className:"text-lg font-semibold mb-2",children:"–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã..."}),e.jsx("p",{className:"text-muted-foreground",children:"–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ä—Ç—É –¥–ª—è –≤–∞—Å"})]})})}export{te as default};
